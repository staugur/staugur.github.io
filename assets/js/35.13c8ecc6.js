(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{515:function(s,n,e){"use strict";e.r(n);var a=e(4),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("如果你服务器被入侵了，该怎么做才能让自己第一时间知晓？")]),s._v(" "),e("p",[s._v("答案很多，其中一个方法是ssh登陆后发送报警信息给相关人员。")]),s._v(" "),e("p",[s._v("ssh远程登陆自身是可以设置提示消息的，比如sshd_config的Banner，不过本文描述另外方法，通过/etc/profile设置。")]),s._v(" "),e("p",[s._v("/etc/profile这个文件是每个用户登录时都会运行的环境变量设置，当用户第一次登录时，该文件被执行， 并从/etc/profile.d目录的配置文件中搜集shell的设置。")]),s._v(" "),e("p",[s._v("依此，我们写个shell脚本在每次远程登陆终端、复制终端时报警。")]),s._v(" "),e("p",[s._v("环境要求：")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("安装jq、screen软件包： yum -y install jq screen")])]),s._v(" "),e("li",[e("p",[s._v("部署脚本，比如/data/public/LoginAlert.sh")])]),s._v(" "),e("li",[e("p",[s._v("/etc/profile追加报警脚本：")]),s._v(" "),e("p",[s._v("比如 screen -fa -d -m -S WL sh /data/public/LoginAlert.sh(shell版本)")]),s._v(" "),e("p",[s._v("比如 screen -fa -d -m -S WL python /data/public/LoginAlert.py(python版本)")])])]),s._v(" "),e("blockquote",[e("p",[s._v("shell版本，LoginAlert.sh脚本内容如下：")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('#!/bin/bash\n# Author: www.saintic.com\n# Email: staugur@saintic.com\n# Date: 2017-08-11\n# Docs: 登陆(新开终端或者复制终端)触发报警消息\n\n#require jq\nif [ ! -f $(which jq) ];then\n    yum -y install jq\nfi\n\n#Geo2IP by Legion(http://www.dwhd.org/)\neval `curl -s "http://ip.taobao.com/service/getIpInfo.php?ip=${SSH_CLIENT%% *}" | jq . | awk -F\':|[ ]+|"\' \'{if($3~/^(country|area|region|city|isp)$/){print $3"="$7}}\'`\n\nif [ $(last $USER |grep "still logged in" |wc -l) != "0" ];then\n    isOnline="会话中"\nelse\n    isOnline="已离线"\nfi\n\nhostIps="$(ip addr|grep inet|grep -v 127.0.0.1 |awk \'{print $2}\' |awk -F / \'{print $1}\')"\narea="${country} ${area} ${region} ${city} ${isp}"\nloginTime=$(date "+%Y-%m-%d %H:%M:%S")\n#html mail content\nmsgContent="<div>\n<h3>服务器SSH登陆提示</h3>\n<p>服务器主机名: `hostname`</p>\n<p>服务器IP地址: ${hostIps}</p>\n<p>登录用户:     ${USER}</p>\n<p>登陆状态:     ${isOnline}</p>\n<p>登录端口:     ${SSH_CLIENT##* }</p>\n<p>登录来源IP:   ${SSH_CLIENT%% *}</p>\n<p>登陆IP归属地: ${area}</p>\n<p>最后登录时间: ${loginTime}</p>\n</div>\n"\n\nif [ ! -z "${SSH_CLIENT%% *}" ]; then\n    # 执行报警任务\n    # 发送邮件、微信，记录日志等\n    :\nfi\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br")])]),e("blockquote",[e("p",[s._v("python版本，LoginAlert.py脚本内容如下：")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# coding: utf8\n# Author: www.saintic.com\n# Email: staugur@saintic.com\n# Date: 2017-08-14\n# Docs: 登陆(新开终端或者复制终端)触发报警消息\n\nimport os\nimport sys\nimport json\nimport time\nimport socket\nimport urllib\nimport urllib2\nreload(sys)\nsys.setdefaultencoding('utf-8')\n\ngetHeader = lambda: {\n    'User-Agent': 'Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)',\n    'Authentication': \"此处头部认证信息\"\n}\n\ndef getNowTime():\n    return time.strftime('%Y-%m-%d %H:%M:%S',time.localtime(time.time()))\n\ndef get(url, use_header=True):\n    request = urllib2.Request(url, getHeader() if use_header else None)\n    response = urllib2.urlopen(request)\n    return json.loads(response.read())\n\ndef post(url, data, use_header=True):\n    \"\"\" POST请求 \"\"\"\n    if isinstance(data, dict):\n        data = urllib.urlencode(data)  # 将字典以url形式编码\n    request = urllib2.Request(url, data, getHeader() if use_header else None)\n    response = urllib2.urlopen(request)\n    return json.loads(response.read())\n\ndef getArea(ip):\n    url = \"http://ip.taobao.com/service/getIpInfo.php?ip=%s\" %ip\n    try:\n        data = get(url, use_header=False)\n    except Exception,e:\n        raise\n    else:\n        if data.get(\"code\") == 0:\n            data = data['data']\n            return u\"%s %s %s %s\" %(data['country'], data['region'], data['city'], data['isp']), u\"%s%s%s\" %(data[\"country\"], data['city'], data[\"isp\"])\n        else:\n            raise ValueError\n\nif __name__ == \"__main__\":\n    try:\n        clientIp, clientPort, serverIp, serverPort = os.getenv(\"SSH_CONNECTION\").split()\n    except AttributeError,e:\n        raise\n    hostname = socket.gethostname()\n    username = os.getenv(\"USER\")\n    loginTime = getNowTime()\n    EmailClientIpArea, WxClientIpArea = getArea(clientIp)\n    isOnline = u'会话中' if os.system('last %s |grep \"still logged in\" &> /dev/null' %username) == 0 else u'已离线'\n    # 定义发送邮件内容\n    EmailMsgContent = u\"\"\"<div>\n<h3>服务器SSH登陆提示</h3>\n<p>服务器主机名: %s</p>\n<p>服务器IP地址: %s</p>\n<p>登录用户:     %s</p>\n<p>登录来源IP:   %s</p>\n<p>登陆IP归属地: %s</p>\n<p>当前是否在线: %s</p>\n<p>最后登录时间: %s</p>\n</div>\"\"\" %(hostname, serverIp, username, clientIp, EmailClientIpArea, isOnline, loginTime)\n    # 定义发送微信内容\n    WxMsgContent ='''[Server SSH Prompt]\\n\\tHostName: %s\\n\\tServerIps: %s\\n\\tLoginUser: %s\\n\\tLoginSourceIP: %s\\n\\tLoginSourceIpArea: %s\\n\\tLastLoginTime: %s''' %(hostname, serverIp, username, clientIp, WxClientIpArea, loginTime)\n    # 执行报警任务\n    # 发送邮件、微信，记录日志等\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br"),e("span",{staticClass:"line-number"},[s._v("69")]),e("br"),e("span",{staticClass:"line-number"},[s._v("70")]),e("br"),e("span",{staticClass:"line-number"},[s._v("71")]),e("br"),e("span",{staticClass:"line-number"},[s._v("72")]),e("br"),e("span",{staticClass:"line-number"},[s._v("73")]),e("br"),e("span",{staticClass:"line-number"},[s._v("74")]),e("br"),e("span",{staticClass:"line-number"},[s._v("75")]),e("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);