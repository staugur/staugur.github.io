(window.webpackJsonp=window.webpackJsonp||[]).push([[84],{381:function(s,n,e){"use strict";e.r(n);var a=e(0),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[e("strong",[s._v("1.环境：")])]),s._v(" "),e("p",[s._v("一台H3C路由器接入外网，有公网IP，内网一台linux(CentOS7.0)做OpenVPN服务器，路由器配了静态NAT。（如果IP紧张，也可以做端口映射。）")]),s._v(" "),e("p",[e("strong",[s._v("2.目标：")])]),s._v(" "),e("p",[s._v("证书认证的内网OpenVPN。")]),s._v(" "),e("p",[e("strong",[s._v("3.步骤：")])]),s._v(" "),e("p",[e("em",[s._v("OpenVPN服务器：")])]),s._v(" "),e("p",[s._v("1.CentOS7采用了最新的firewalld机制替代了iptables(默认iptables服务未安装)，为了方便使用一下命令直接关掉。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("systemctl stop firewalld\n\nsystemctl disable firewalld\n\nsystemctl stop iptables "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# CentOS7默认没启用iptables")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("2.安装软件生成证书")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("yum \\-y install pam-devel openssl-devel lzo-devel automake gcc gcc-c++ patch\n\nyum install \\-y pkcs11-helper pkcs11-helper-devel\n\n# 过程：（先同步时间！ntpdate ntp.pool.org）\n\nwget https://static.saintic.com/download/thirdApp/OpenVPN/openvpn-2.1_rc21.tar.gz\n\nwget https://static.saintic.com/download/thirdApp/OpenVPN/openvpn-2.1_rc21_eurephia.patch\n\ntar zxf openvpn-2.1\\_rc19.tar.gz ; cd openvpn-2.1\\_rc19\n\npatch \\-p1 \\< ../openvpn-2.1\\_rc21\\_eurephia.patch\n\n./configure \\&\\& make \\&\\& make install\n\ncd easy-rsa/2.0/\n\nvim vars ; source ./vars ##修改默认国家、组织、邮件等，可不修改\n\n./clean-all\n\n./build-ca ##创建根证书，可以加上--batch免交互确认\n\n./build-key-server server ##创建服务器证书，可以加上--batch免交互确认\\(./build-key-server \\--batch server\\)\n\n./build-dh ##使用DH加密\n\n./build-key client ##创建客户端证书，可以加上--batch免交互确认或使用./pkitool client\n\ncd keys\n\nmkdir /etc/openvpn\n\ncp ca.crt ca.key dh1024.pem server.key server.crt client.\\* ../../../sample-config-files/server.conf /etc/openvpn\n\ncp ../../../sample-scripts/openvpn.init /etc/init.d/openvpn\n\nchkconfig \\--add openvpn\n\nchkconfig openvpn on\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br")])]),e("p",[s._v("3.修改配置文件/etc/openvpn/server.conf")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(';local\n\nport 1194\n\nproto udp\n\ndev tun\n\nca ca.crt\n\ncert server.crt\n\nkey server.key\n\ndh dh1024.pem\n\nserver 192.168.234.0 255.255.255.0\n\nifconfig-pool-persist ipp.txt\n\npush "route 192.168.1.0 255.255.255.0" ##向客户端推送内网网段\n\npush "route 192.168.234.0 255.255.255.0" ##推送VPN网段\n\npush "dhcp-option DNS 192.168.1.153" ##推送首选DNS，可以多个\n\npush "dhcp-option DNS 114.114.114.114"\n\nclient-to-client ##允许OpenVPN客户端之间通信\n\nduplicate-cn\n\nkeepalive 10 120\n\ncomp-lzo\n\nuser nobody ##默认的程序用户，建议以低权限账户运行\n\ngroup nobody\n\npersist-key\n\npersist-tun\n\nstatus openvpn-status.log\n\nlog openvpn.log\n\nverb 3\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br")])]),e("p",[s._v("4.开启转发，并关闭防火墙和 SELinux")]),s._v(" "),e("p",[s._v("vim /etc/sysctl.conf #修改net.ipv4.ip_forward = 0")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("net.ipv4.ip_forward = 1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("sysctl -p ##让sysctl.conf生效")]),s._v(" "),e("p",[s._v("vim /etc/sysconfig/selinux")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("SELINUX=disabled\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("reboot #修改了SELinux需要reboot，临时禁用SELinux使用setenforce 0")]),s._v(" "),e("p",[s._v("5. iptables转发规则")]),s._v(" "),e("p",[s._v("centos7，需要安装iptables的服务，  yum  install iptables-services -y")]),s._v(" "),e("p",[s._v('需要所有流量通过vpn出口时server.conf添加一条 push "redirect-gateway def1 bypass-dhcp"，添加iptables规则， iptables -t nat -A POSTROUTING -s 192.168.234.0/24 -o 出口网卡 -j MASQUERADE')]),s._v(" "),e("p",[s._v("6.H3C路由器：")]),s._v(" "),e("p",[s._v("添加一条VPN内网路由，下一跳指向OpenVPN服务器！")]),s._v(" "),e("p",[s._v("客户端配置：")]),s._v(" "),e("p",[s._v("win7 win8安装"),e("a",{attrs:{href:"https://static.saintic.com/download/thirdApp/OpenVPN/openvpn-install-2.3.6-I601-x86_64.exe",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://static.saintic.com/download/thirdApp/OpenVPN/openvpn-install-2.3.6-I601-x86_64.exe"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("winxp安装"),e("a",{attrs:{href:"https://static.saintic.com/download/thirdApp/OpenVPN/openvpn-2.0.9-gui-1.0.3-install-FOR_-XP.exe",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://static.saintic.com/download/thirdApp/OpenVPN/openvpn-2.0.9-gui-1.0.3-install-FOR_-XP.exe"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("将./build-key client这一步产生的client.crt client.key ca.crt复制到客户端安装目录下的config/")]),s._v(" "),e("p",[s._v("将安装目录下的sample-config/client.ovpn复制到config/下，修改其中的remote VPN-SERVER-IP Port，即remote OpenVPN服务器IP 端口(默认是1194)")]),s._v(" "),e("p",[s._v("然后以管理员身份启动OpenVPN GUI，避免无法创建路由问题。")]),s._v(" "),e("p",[s._v("附录一个一键部署openvpn的脚本:")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/staugur/scripts/blob/master/services/openvpn.sh",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/staugur/scripts/blob/master/services/openvpn.sh"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("# 自行下载，可能需要根据注释修改些变量。")]),s._v(" "),e("p",[s._v("# 脚本并没有一键完成所有，您还要按需配置。")])])}),[],!1,null,null,null);n.default=t.exports}}]);