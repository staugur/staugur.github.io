<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=author content="Hiroshi.tao"><meta name=description content="Hiroshi.tao の 网络日志"><meta name=keywords content="SaintIC,staugur,Linux,DevOps,sys,python,go,js,vue,picbed,sapic,Flask-PluginKit,rtfd"><link rel=prev href=https://blog.saintic.com/blog/258.html><link rel=next href=https://blog.saintic.com/blog/261.html><link rel=canonical href=https://blog.saintic.com/blog/259.html><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Inception部署 | 陶先森de博客</title><meta name=title content="Inception部署 | 陶先森de博客"><link rel=stylesheet href=/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.saintic.com"},"articleSection":"blog","name":"Inception部署","headline":"Inception部署","description":"Inception是集审核、执行、回滚于一体的一个SQL自动化运维系统，基于MySQL代码修改，官方文档地址：https:\/\/mysql-i","inLanguage":"zh-cn","author":"Hiroshi.tao","creator":"Hiroshi.tao","publisher":"Hiroshi.tao","accountablePerson":"Hiroshi.tao","copyrightHolder":"Hiroshi.tao","copyrightYear":"2018","datePublished":"2018-07-19 00:00:00 \u002b0000 UTC","dateModified":"2018-07-19 00:00:00 \u002b0000 UTC","url":"https:\/\/blog.saintic.com\/blog\/259.html","wordCount":"2429","keywords":["Inception","陶先森de博客"]}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-back2home-logo"><span class=logo_mark>>$</span>
<a href=https://blog.saintic.com><span class=logo_text>cd /home/</span>
<span class=logo_cursor></span></a></div><div class=navbar-right><span class=menu><a class=menu-item href=/blog.html title>Posts</a>
<a class=menu-item href=/categories.html title>Categories</a>
<a class=menu-item href=/tags.html title>Tags</a>
<a class=menu-item href=/link.html title>Links</a>
<a class=menu-item href="https://www.baidu.com/s?wd=site:blog.saintic.com+" title>Search</a>
<a class=menu-item href=/about.html title=About>About</a>
<span class=divide></span><a href=javascript:void(0); class=theme-switch><i class="saintic-icon saintic-icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://blog.saintic.com>陶先森de博客</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="saintic-icon saintic-icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=/blog.html title><h3>Posts</h3><div class=menu-active></div></a><a class=menu-item href=/categories.html title><h3>Categories</h3><div class=menu-active></div></a><a class=menu-item href=/tags.html title><h3>Tags</h3><div class=menu-active></div></a><a class=menu-item href=/link.html title><h3>Links</h3><div class=menu-active></div></a><a class=menu-item href="https://www.baidu.com/s?wd=site:blog.saintic.com+" title><h3>Search</h3><div class=menu-active></div></a><a class=menu-item href=/about.html title=About><h3>About</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">Inception部署</h1><div class=post-meta>Written by <a itemprop=name href=https://blog.saintic.com rel=author>Hiroshi.tao</a> with ♥
<span class=post-time>on <time datetime=2018-07-19 itemprop=datePublished>July 19, 2018</time></span>
in
<i class="saintic-icon saintic-icon-folder"></i><span class=post-category><a href=https://blog.saintic.com/categories/%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1.html>应用服务</a></span>
<span class=post-word-count>2429 words</span></div></header><div class=post-content><p>Inception是集审核、执行、回滚于一体的一个SQL自动化运维系统，基于MySQL代码修改，官方文档地址：<a href=https://mysql-inception.github.io/inception-document/>https://mysql-inception.github.io/inception-document/</a></p><h2 id=一inception部署篇>一、Inception部署篇</h2><p>官方部署说明：<a href=https://mysql-inception.github.io/inception-document/install/>https://mysql-inception.github.io/inception-document/install/</a></p><p>我的环境：centos7.4</p><p>我的安装步骤：</p><p>1. 安装依赖</p><pre><code>yum -y install gcc gcc-c++ make cmake openssl-devel ncurses-devel perl unzip m4 MySQL-python perl-ExtUtils-Embed perl-DBI perl-DBD-MySQL perl-Digest-MD5 perl-Data-Dumper

(Ubuntu下执行apt-get install cmake libncurses5-dev libssl-dev g++ m4，没有perl的话也要安装)
</code></pre><p>2. 安装bison，官方建议2.6版本之前</p><pre><code>wget -c https://static.saintic.com/download/inception/bison-2.5.1.tar &amp;&amp; tar xf bison-2.5.1.tar &amp;&amp; cd bison-2.5.1 &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install
</code></pre><p>3. 安装percona-toolkit，在线修改大表用的工具</p><pre><code>wget -c https://static.saintic.com/download/inception/percona-toolkit-2.2.20.tar.gz &amp;&amp; tar zxf percona-toolkit-2.2.20.tar.gz &amp;&amp; cd percona-toolkit-2.2.20 &amp;&amp; perl Makefile.PL &amp;&amp; make install
</code></pre><p>4. 安装主程序inception</p><pre><code>git clone https://github.com/mysql-inception/inception &amp;&amp; cd inception

编译inception可以用官方的方法，sh inception_build.sh，也可以cmake编译，我这里用cmake演示(因为后面docker编译用cmake没有问题)。

cmake -DWITH_DEBUG=OFF -DCMAKE_INSTALL_PREFIX=/Inception -DMYSQL_DATADIR=/Inception/data -DWITH_SSL=bundled -DCMAKE_BUILD_TYPE=RELEASE -DWITH_ZLIB=bundled -DMY_MAINTAINER_CXX_WARNINGS=&quot;-Wall -Wextra -Wunused -Wno-dev -Wwrite-strings -Wno-strict-aliasing -Wno-unused-parameter -Woverloaded-virtual&quot; -DMY_MAINTAINER_C_WARNINGS=&quot;-Wall -Wextra -Wno-dev -Wunused -Wwrite-strings -Wno-strict-aliasing -Wdeclaration-after-statement&quot; &amp;&amp; make &amp;&amp; make install

注意红色部分，编译好的程序目录即可，可执行命令在这目录的bin下。
</code></pre><p>5. 启动</p><pre><code>/Inception/bin/Inception --defaults-file=/etc/inception.cnf   #此配置文件参见底部附录
</code></pre><h2 id=二docker镜像>二、Docker镜像</h2><p>上述过程已经被我打包成镜像，基于centos7.4，可以直接使用，镜像支持OSC，默认配置文件为官方推荐配置(参见底部附录)，可以自定义挂载覆盖/etc/inception.cnf，默认了以下参数可以设置环境变量：</p><table><tbody><tr><td><code>bind_address</code>，默认127.0.0.1。<br><code>port</code>，默认6669<br><code style=font-size:12.6px>inception_support_charset</code>，字符集，默认utf8mb4<br><code>inception_remote_backup_host</code>，远程备份服务器的地址<br><code>inception_remote_backup_port</code>，远程备份服务器的端口<br><code>inception_remote_system_user</code>，远程备份服务器的用户<br><code>inception_remote_system_password</code>，远程备份服务器的密码<br><code>inception_osc_on</code>, 是否开启osc，1是开启，0是关闭(默认)</td></tr></tbody></table><ol><li><p>拉取镜像</p><p><code>docker pull registry.cn-beijing.aliyuncs.com/staugur/inception:v0.1</code></p></li><li><p>运行镜像(可以跳过第一步，此处假定远程备份地址127.0.0.1，端口3306，账号root，密码123456)</p><p>docker run -tdi &ndash;name inception -e bind_address=0.0.0.0 -e port=6669 -e inception_remote_backup_host=127.0.0.1 -e inception_remote_backup_port=3306 -e inception_remote_system_user=root -e inception_remote_system_password=123456 &ndash;net=host registry.cn-beijing.aliyuncs.com/staugur/inception:v0.1</p></li><li><p>查看日志：<code>docker logs inception</code></p><p>The inception listens for 0.0.0.0:6669</p><p>2018-07-19 03:40:15 0 [Note] Welcome to use Inception2.1.50</p><p>2018-07-19 03:40:15 6 [Note] Server hostname (bind-address): &lsquo;0.0.0.0&rsquo;; port: 6669</p><p>2018-07-19 03:40:15 6 [Note] - &lsquo;0.0.0.0&rsquo; resolves to &lsquo;0.0.0.0&rsquo;;</p><p>2018-07-19 03:40:15 6 [Note] Server socket created on IP: &lsquo;0.0.0.0&rsquo;.</p></li></ol><h2 id=三访问>三、访问</h2><p>使用mysql命令即可，需要指定inception的ip地址和端口，如<code>mysql \-h127.0.0.1 \-P6669</code></p><p>登录成功界面如下图，此时执行 <code>inception get variables;</code> 命令可以获取系统参数。</p><p><img src=https://static.saintic.com/EauDouce/blog/201807191146533596.png alt=QQ截图20180719114556 loading=lazy></p><h2 id=四附录>四、附录</h2><p>1. 配置文件/etc/inception.cnf</p><p>此配置文件基本是官方参数默认值，docker运行时可以使用 <code>-v 你的配置文件:/etc/inception.cnf </code>覆盖它。</p><p>官方参数文档地址：<a href=https://mysql-inception.github.io/inception-document/variables/>https://mysql-inception.github.io/inception-document/variables/</a></p><p>配置文件内容如下($变量请在在docker运行时覆盖)：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#66d9ef>[inception]</span>
<span style=color:#a6e22e>general_log</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#a6e22e>general_log_file</span><span style=color:#f92672>=</span><span style=color:#e6db74>/var/log/inception.log</span>
<span style=color:#75715e>#这个参数实际上就是MySQL数据库原来的参数，因为Incpetion没有权限验证过程，那么为了实现更安全的访问，可以给Inception服务器的这个参数设置某台机器（Inception上层的应用程序）不地址，这样</span>
<span style=color:#75715e>#其它非法程序是不可访问的，那么再加上Inception执行的选项中的用户名密码，对MySQL就更加安全</span>
<span style=color:#a6e22e>bind_address</span><span style=color:#f92672>=</span><span style=color:#e6db74>$bind_address</span>
<span style=color:#a6e22e>port</span><span style=color:#f92672>=</span><span style=color:#e6db74>$port</span>
<span style=color:#a6e22e>socket</span><span style=color:#f92672>=</span><span style=color:#e6db74>/var/run/inception.socket</span>
<span style=color:#a6e22e>character-set-client-handshake</span><span style=color:#f92672>=</span><span style=color:#e6db74>0</span>
<span style=color:#a6e22e>character-set-server</span><span style=color:#f92672>=</span><span style=color:#e6db74>utf8</span>

<span style=color:#75715e>#备份相关</span>
<span style=color:#75715e>#需要开启binlog</span>
<span style=color:#a6e22e>inception_remote_system_password</span><span style=color:#f92672>=</span><span style=color:#e6db74>$inception_remote_system_password</span>
<span style=color:#a6e22e>inception_remote_system_user</span><span style=color:#f92672>=</span><span style=color:#e6db74>$inception_remote_system_user</span>
<span style=color:#a6e22e>inception_remote_backup_port</span><span style=color:#f92672>=</span><span style=color:#e6db74>$inception_remote_backup_port</span>
<span style=color:#a6e22e>inception_remote_backup_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>$inception_remote_backup_host</span>

<span style=color:#75715e>#在DML语句中没有WHERE条件时，是不是要报错</span>
<span style=color:#a6e22e>inception_check_dml_where</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#在DML语句中使用了LIMIT时，是不是要报错</span>
<span style=color:#a6e22e>inception_check_dml_limit</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#在DML语句中使用了Order By时，是不是要报错</span>
<span style=color:#a6e22e>inception_check_dml_orderby</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#Select*时是不是要报错</span>
<span style=color:#a6e22e>inception_enable_select_star</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#order by rand时是不是报错</span>
<span style=color:#a6e22e>inception_enable_orderby_rand</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#创建或者新增列时如果列为NULL，是不是报错</span>
<span style=color:#a6e22e>inception_enable_nullable</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#是不是支持外键</span>
<span style=color:#a6e22e>inception_enable_foreign_key</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#一个索引中，列的最大个数，超过这个数目则报错(1-64)</span>
<span style=color:#a6e22e>inception_max_key_parts</span><span style=color:#f92672>=</span><span style=color:#e6db74>5</span>
<span style=color:#75715e>#在一个修改语句中，预计影响的最大行数，超过这个数就报错(1-max)</span>
<span style=color:#a6e22e>inception_max_update_rows</span><span style=color:#f92672>=</span><span style=color:#e6db74>10000</span>
<span style=color:#75715e>#一个表中，最大的索引数目，超过这个数则报错(1-1024)</span>
<span style=color:#a6e22e>inception_max_keys</span><span style=color:#f92672>=</span><span style=color:#e6db74>16</span>
<span style=color:#75715e>#建表指定的存储引擎不为Innodb，不报错</span>
<span style=color:#a6e22e>inception_enable_not_innodb</span><span style=color:#f92672>=</span><span style=color:#e6db74>0</span>
<span style=color:#75715e>#表示在建表或者建库时支持的字符集，如果需要多个，则用逗号分隔，影响的范围是建表、设置会话字符集、修改表字符集属性等</span>
<span style=color:#a6e22e>inception_support_charset</span><span style=color:#f92672>=</span><span style=color:#e6db74>$inception_support_charset</span>
<span style=color:#75715e>#建表时，表没有注释时报错</span>
<span style=color:#a6e22e>inception_check_table_comment</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#建表时，列没有注释时报错</span>
<span style=color:#a6e22e>inception_check_column_comment</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#建表时，如果没有主键，则报错</span>
<span style=color:#a6e22e>inception_check_primary_key</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#是不是支持分区表</span>
<span style=color:#a6e22e>inception_enable_partition_table</span><span style=color:#f92672>=</span><span style=color:#e6db74>0</span>
<span style=color:#75715e>#是不是支持enum,set,bit数据类型</span>
<span style=color:#a6e22e>inception_enable_enum_set_bit</span><span style=color:#f92672>=</span><span style=color:#e6db74>0</span>
<span style=color:#75715e>#是不是要检查索引名字前缀为&#34;idx_&#34;，检查唯一索引前缀是不是&#34;uniq_&#34;</span>
<span style=color:#a6e22e>inception_check_index_prefix</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#自增列是不是要为无符号型</span>
<span style=color:#a6e22e>inception_enable_autoincrement_unsigned</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#当char类型的长度大于这个值时，就提示将其转换为VARCHAR(1-max)</span>
<span style=color:#a6e22e>inception_max_char_length</span><span style=color:#f92672>=</span><span style=color:#e6db74>16</span>
<span style=color:#75715e>#当建表时自增列的值指定的不为1，则报错</span>
<span style=color:#a6e22e>inception_check_autoincrement_init_value</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#当建表时自增列的类型不为int或者bigint时报错</span>
<span style=color:#a6e22e>inception_check_autoincrement_datatype</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#建表时，如果没有为timestamp类型指定默认值，则报错</span>
<span style=color:#a6e22e>inception_check_timestamp_default</span><span style=color:#f92672>=</span><span style=color:#e6db74>0</span>
<span style=color:#75715e>#允许列自己设置字符集</span>
<span style=color:#a6e22e>inception_enable_column_charset</span><span style=color:#f92672>=</span><span style=color:#e6db74>0</span>
<span style=color:#75715e>#建表时，如果指定的自增列的名字不为ID，则报错，说明是有意义的，给提示</span>
<span style=color:#a6e22e>inception_check_autoincrement_name</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#在多个改同一个表的语句出现时，报错，提示合成一个</span>
<span style=color:#a6e22e>inception_merge_alter_table</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#检查在建表、修改列、新增列时，新的列属性是不是要有默认值</span>
<span style=color:#a6e22e>inception_check_column_default_value</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#检查是不是支持BLOB字段，包括建表、修改列、新增列操作</span>
<span style=color:#a6e22e>inception_enable_blob_type</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#检查在SQL语句中，是不是有标识符被写成MySQL的关键字，默认值为报警。</span>
<span style=color:#a6e22e>inception_enable_identifer_keyword</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>
<span style=color:#75715e>#这个参数的作用是为了匹配Python客户端每次自动设置auto_commit=0的，如果取消则会报错，针对Inception本身没有实际意义</span>
<span style=color:#75715e>#auto_commit=0</span>

<span style=color:#75715e>#打开与关闭Inception对SQL语句中各种名字的检查，如果设置为ON，则如果发现名字中存在除数字字母下划线之外的字符时，报Identifier &#34;invalidname&#34; is invalid, valid options: [a-z,A-Z,0-9,_].</span>
<span style=color:#a6e22e>inception_check_identifier</span><span style=color:#f92672>=</span><span style=color:#e6db74>1</span>

<span style=color:#75715e>#开启对OSC的支持</span>
<span style=color:#a6e22e>inception_osc_on</span><span style=color:#f92672>=</span><span style=color:#e6db74>$inception_osc_on</span>
<span style=color:#a6e22e>inception_osc_bin_dir</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/local/bin/pt-online-schema-change</span>
</code></pre></div><br><center>·End·</center></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>Hiroshi.tao</span></p><p class=copyright-item><span>Link:</span>
<a href=https://blog.saintic.com/blog/259.html>https://blog.saintic.com/blog/259.html</span></p><p class="copyright-item lincese">本文采用 <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/ target=_blank>知识共享署名-非商业性使用 4.0 国际许可协议</a> 进行许可</p></div><div class=post-tags><section><i class="saintic-icon saintic-icon-tag"></i>Tag(s):
<a href=/tags/inception.html rel=tag class=post-tags-link>#Inception</a></section><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://blog.saintic.com>home</a></span></section></div><div class=post-nav><a href=https://blog.saintic.com/blog/258.html class=prev rel=prev title=python使用zip压缩目录及相关问题><i class="saintic-icon saintic-icon-angle-left"></i>&nbsp;python使用zip压缩目录及相关问题</a>
<a href=https://blog.saintic.com/blog/261.html class=next rel=next title=开源项目之IncetOps>开源项目之IncetOps&nbsp;<i class="saintic-icon saintic-icon-angle-right"></i></a></div><div class=post-comment><div id=utteranc-container><script src=https://utteranc.es/client.js repo=staugur/staugur.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2017 - 2021</span>
<span class=with-love><i class="saintic-icon saintic-icon-love"></i></span><span class=author itemprop=copyrightHolder><a href=https://blog.saintic.com>Hiroshi.tao</a> |</span>
<a href=http://www.miibeian.gov.cn/ target=_blank rel="external nofollow">京ICP备14058611号</a> |
<span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/Mogeko/Mogege target=_blank rel="external nofollow">Mogege</a></span></div></footer><script defer src=/js/vendor_main.min.js></script><script src=https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script><script>pangu.spacingPage()</script>>
<script defer src=https://blog.saintic.com/js/_custom.js></script></div></body></html>