<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=author content="Hiroshi.tao"><meta name=description content="一念博客，陶先森の博客，IT博客，技术记录与分享，开源项目与文档"><meta name=keywords content="SaintIC,Hiroshi.tao,Blog,博客,Linux,DevOps,sys,python,go,js,vue,flask,picbed,sapic,Flask-PluginKit,rtfd"><link rel=prev href=https://blog.saintic.com/blog/312.html><link rel=canonical href=https://blog.saintic.com/blog/313.html><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>CentOS/Ubuntu 源码编译安装升级 OpenSSH v8.9 | 一念博客</title><meta name=title content="CentOS/Ubuntu 源码编译安装升级 OpenSSH v8.9 | 一念博客"><link rel=stylesheet href=/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.saintic.com"},"articleSection":"blog","name":"CentOS\/Ubuntu 源码编译安装升级 OpenSSH v8.9","headline":"CentOS\/Ubuntu 源码编译安装升级 OpenSSH v8.9","description":"前言 由于一次大规模安全演示扫描到一些 Linux 系统存在很多 OpenSSH 相关漏洞， 按照扫描建议，很多都建议升级到高版本（yum\/apt无法更新到最新），索性直接","inLanguage":"zh-cn","author":"Hiroshi.tao","creator":"Hiroshi.tao","publisher":"Hiroshi.tao","accountablePerson":"Hiroshi.tao","copyrightHolder":"Hiroshi.tao","copyrightYear":"2022","datePublished":"2022-06-28 19:30:01 \u002b0800 \u002b0800","dateModified":"2022-06-28 19:30:01 \u002b0800 \u002b0800","url":"https:\/\/blog.saintic.com\/blog\/313.html","wordCount":"1096","keywords":["linux","ssh","一念博客"]}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-back2home-logo"><span class=logo_mark>>$</span>
<a href=https://blog.saintic.com><span class=logo_text>cd /home/</span>
<span class=logo_cursor></span></a></div><div class=navbar-right><span class=menu><a class=menu-item href=/blog.html title>Blog</a>
<a class=menu-item href=/note.html title>Note</a>
<a class=menu-item href=/categories.html title>Categories</a>
<a class=menu-item href=/tags.html title>Tags</a>
<a class=menu-item href=/link.html title>Links</a>
<a class=menu-item href="https://www.baidu.com/s?wd=site:blog.saintic.com+" title>Baidu</a>
<a class=menu-item href="https://www.google.com/search?q=site:blog.saintic.com+" title>Google</a>
<a class=menu-item href=/about.html title=About>About</a>
<span class=divide></span>
<a href=javascript:void(0); class=theme-switch><i class="saintic-icon saintic-icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://blog.saintic.com>一念博客</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="saintic-icon saintic-icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=/blog.html title><h3>Blog</h3><div class=menu-active></div></a><a class=menu-item href=/note.html title><h3>Note</h3><div class=menu-active></div></a><a class=menu-item href=/categories.html title><h3>Categories</h3><div class=menu-active></div></a><a class=menu-item href=/tags.html title><h3>Tags</h3><div class=menu-active></div></a><a class=menu-item href=/link.html title><h3>Links</h3><div class=menu-active></div></a><a class=menu-item href="https://www.baidu.com/s?wd=site:blog.saintic.com+" title><h3>Baidu</h3><div class=menu-active></div></a><a class=menu-item href="https://www.google.com/search?q=site:blog.saintic.com+" title><h3>Google</h3><div class=menu-active></div></a><a class=menu-item href=/about.html title=About><h3>About</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><div class=toc><div class=page-header><strong>- 目录 -</strong></div><div id=page-scrollspy class=toc-nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e5%89%8d%e8%a8%80>前言</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e5%87%86%e5%a4%87>准备</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e6%89%8b%e5%8a%a8%e5%8d%87%e7%ba%a7%e6%93%8d%e4%bd%9c>手动升级操作</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#1-%e5%87%86%e5%a4%87%e8%bd%af%e4%bb%b6%e5%8c%85>1. 准备软件包</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#2-%e5%ae%89%e8%a3%85%e4%be%9d%e8%b5%96%e5%8c%85>2. 安装依赖包</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#3-%e8%a7%a3%e5%8e%8b>3. 解压</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#4-%e7%bc%96%e8%af%91>4. 编译</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#5-%e5%ae%89%e8%a3%85>5. 安装</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#6-%e9%85%8d%e7%bd%ae>6. 配置</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#7-%e5%ae%8c%e6%88%90>7. 完成</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e8%87%aa%e5%8a%a8%e5%8d%87%e7%ba%a7%e6%93%8d%e4%bd%9c>自动升级操作</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e5%bc%95%e7%94%a8>引用</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e6%b8%a9%e9%a6%a8%e6%8f%90%e7%a4%ba>温馨提示</a></li></ul></ul></ul></div></div><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">CentOS/Ubuntu 源码编译安装升级 OpenSSH v8.9</h1><div class=post-meta>Written by <a itemprop=name href=https://blog.saintic.com rel=author>Hiroshi.tao</a> with ♥
<span class=post-time>on <time datetime=2022-06-28 itemprop=datePublished>June 28, 2022</time></span>
in
<i class="saintic-icon saintic-icon-folder"></i>
<span class=post-category><a href=https://blog.saintic.com/categories/linux.html>linux</a></span>
<span class=post-word-count>1096 words</span></div></header><div class=post-content><h3 id=前言>前言</h3><p>由于一次大规模安全演示扫描到一些 Linux 系统存在很多 OpenSSH 相关漏洞，
按照扫描建议，很多都建议升级到高版本（yum/apt无法更新到最新），索性直接升级到 v8.9。</p><p>实验系统：CentOS 7.9</p><p>当前版本：OpenSSH 7.4p</p><h3 id=准备>准备</h3><p>请到 <a href=https://www.openssh.com/>OpenSSH官网</a> 下载8.9的软件包</p><p>官网不算很清晰，我们的系统是 CentOS，在网页左侧找到 &lsquo;For other systems&rsquo; 中的 &lsquo;Releases&rsquo;，
点击进入，页面中有 &lsquo;Installation instructions&rsquo; 安装指导（也就是软件包内也的INSTALL），
页面再往下有 &lsquo;Download&rsquo; 下载链接，可以自行选择下载方式，以国内阿里云镜像为例：
<a href=https://mirrors.aliyun.com/pub/OpenBSD/OpenSSH/portable/openssh-8.9p1.tar.gz>openssh-8.9p1.tar.gz</a></p><p>由安装指导中，第一条 &lsquo;Prerequisites&rsquo; 得知依赖的 OpenSSL 版本 1.0.x >= 1.0.1 or 1.1.0 >= 1.1.0g or any 1.1.1
皆可，我系统中版本是 1.0.2k，满足要求，不用升级 OpenSSL。</p><h3 id=手动升级操作>手动升级操作</h3><h4 id=1-准备软件包>1. 准备软件包</h4><p>从 &lsquo;准备&rsquo; 一节中可以下载到 openssh v8.9 的软件包，任意方式上传到服务器或在服务器 wget/curl 直接下载。</p><h4 id=2-安装依赖包>2. 安装依赖包</h4><p>CentOS/RHEL系列执行命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install -y gcc openssl-devel zlib-devel pam-devel
</span></span></code></pre></div><p>Ubuntu/Debian系列执行命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt update <span style=color:#f92672>&amp;&amp;</span> apt install -y build-essential libssl-dev libz-dev libpam-dev
</span></span></code></pre></div><h4 id=3-解压>3. 解压</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tar zxf openssh-8.9p1.tar.gz
</span></span><span style=display:flex><span>cd openssh-8.9p1
</span></span></code></pre></div><h4 id=4-编译>4. 编译</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -h
</span></span></code></pre></div><p>参数很多，含义可以看help提示，我们直接覆盖安装（覆盖系统本身版本的命令），配置目录还是<code>/etc/ssh</code>，编译如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure --prefix<span style=color:#f92672>=</span>/usr/ --sysconfdir<span style=color:#f92672>=</span>/etc/ssh/ --with-pam --with-zlib --with-ssl-engine
</span></span><span style=display:flex><span>make
</span></span></code></pre></div><h4 id=5-安装>5. 安装</h4><p>上述编译通过后，可以执行install安装命令工具，这一步会覆盖原来的ssh相关命令，由于安装会生成新的key等等，
存在配置目录会失败，我们直接备份原<code>/etc/ssh</code>配置目录：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mv /etc/ssh /etc/ssh.old
</span></span><span style=display:flex><span>make install
</span></span></code></pre></div><h4 id=6-配置>6. 配置</h4><p>现在已经升级到新版本了，它的服务配置文件也需要修改，否则重启服务会卡死超时导致失败：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp -f /etc/ssh.old/sshd_config /etc/ssh/
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s/Type=notify/Type=simple/&#39;</span> /lib/systemd/system/sshd.service <span style=color:#f92672>||</span> sed -i <span style=color:#e6db74>&#39;s/Type=notify/Type=simple/&#39;</span> /lib/systemd/system/ssh.service
</span></span><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl restart sshd
</span></span></code></pre></div><h4 id=7-完成>7. 完成</h4><p>升级完成，查看版本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh -V
</span></span></code></pre></div><h3 id=自动升级操作>自动升级操作</h3><p>本节shell函数封装了上述手动操作步骤，适用于 CentOS（Ubuntu系统请注释 <code>yum install</code> 那一行，并取消 <code>apt install</code> 那一行的注释）。</p><p>用法：</p><ol><li>下载软件包（或手动上传）：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget -c https://mirrors.aliyun.com/pub/OpenBSD/OpenSSH/portable/openssh-8.9p1.tar.gz
</span></span></code></pre></div><ol start=2><li>将下方整个函数块复制并粘贴到系统后，执行 <code>_upgrade_ssh</code> 即可完成更新（执行时确保与上面软件包位于同目录）：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>_upgrade_ssh<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    set -e
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;Please run as root&#34;</span>
</span></span><span style=display:flex><span>        exit <span style=color:#ae81ff>128</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 安装依赖包</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># CentOS/RHEL</span>
</span></span><span style=display:flex><span>    yum install -y gcc openssl-devel zlib-devel pam-devel
</span></span><span style=display:flex><span>    <span style=color:#75715e># Ubuntu</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#apt update &amp;&amp; apt install -y build-essential libssl-dev libz-dev libpam-dev</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 解压、编译、安装</span>
</span></span><span style=display:flex><span>    tar zxf openssh-8.9p1.tar.gz
</span></span><span style=display:flex><span>    cd openssh-8.9p1
</span></span><span style=display:flex><span>    ./configure --prefix<span style=color:#f92672>=</span>/usr/ --sysconfdir<span style=color:#f92672>=</span>/etc/ssh/ --with-pam --with-zlib --with-ssl-engine
</span></span><span style=display:flex><span>    make
</span></span><span style=display:flex><span>    /bin/mv -f /etc/ssh /etc/ssh.old
</span></span><span style=display:flex><span>    make install
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 还原配置文件</span>
</span></span><span style=display:flex><span>    /bin/cp -f /etc/ssh.old/sshd_config /etc/ssh/
</span></span><span style=display:flex><span>    <span style=color:#75715e># 修改、重载服务</span>
</span></span><span style=display:flex><span>    sed -i <span style=color:#e6db74>&#39;s/Type=notify/Type=simple/&#39;</span> /lib/systemd/system/sshd.service <span style=color:#f92672>||</span> sed -i <span style=color:#e6db74>&#39;s/Type=notify/Type=simple/&#39;</span> /lib/systemd/system/ssh.service <span style=color:#f92672>||</span> false
</span></span><span style=display:flex><span>    systemctl daemon-reload
</span></span><span style=display:flex><span>    systemctl restart sshd
</span></span><span style=display:flex><span>    ssh -V
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Upgrade OpenSSH: successfully&#34;</span>
</span></span><span style=display:flex><span>    set +e
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=引用>引用</h3><ul><li><a href=https://www.trickyedecay.me/2021/07/19/how-to-update-openssh-on-centos/>centos 如何升级 openssh</a></li></ul><h3 id=温馨提示>温馨提示</h3><ol><li><p>升级 OpenSSH 属于危险操作（对于远程管理），建议先在测试机测试后进行，同时建议保留多种登录方式，以及升级中多开一个窗口。</p></li><li><p>如果不想保留系统原生openssh软件包，可以卸载：</p></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rpm -e --nodeps <span style=color:#e6db74>`</span>rpm -qa | grep openssh<span style=color:#e6db74>`</span>
</span></span></code></pre></div><ol start=3><li>升级时由于重建了 /etc/ssh，升级后客户端连接时可能出现指纹错误，重新接受新指纹即可。</li></ol><br><center>·End·</center></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>Hiroshi.tao</span></p><p class=copyright-item><span>Link:</span>
<a href=https://blog.saintic.com/blog/313.html>https://blog.saintic.com/blog/313.html</span></p><p class="copyright-item lincese">本文采用 <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/ target=_blank>知识共享署名-非商业性使用 4.0 国际许可协议</a> 进行许可</p></div><div class=post-tags><section><i class="saintic-icon saintic-icon-tag"></i>Tag(s):
<a href=/tags/linux.html rel=tag class=post-tags-link>#linux</a>
<a href=/tags/ssh.html rel=tag class=post-tags-link>#ssh</a></section><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://blog.saintic.com>home</a></span></section></div><div class=post-nav><a href=https://blog.saintic.com/blog/312.html class=prev rel=prev title="CentOS 7 安装 Apt-Cacher-NG 为 Ubuntu/Debian 提供软件源服务"><i class="saintic-icon saintic-icon-angle-left"></i>&nbsp;CentOS 7 安装 Apt-Cacher-NG 为 Ubuntu/Debian 提供软件源服务</a></div><div class=post-comment><div id=utteranc-container><script src=https://utteranc.es/client.js repo=staugur/staugur.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2017 - 2022</span>
<span class=with-love><i class="saintic-icon saintic-icon-love"></i></span>
<span class=author itemprop=copyrightHolder><a href=https://blog.saintic.com>Hiroshi.tao</a> |</span>
<a href=https://beian.miit.gov.cn/ target=_blank rel="external nofollow">京ICP备14058611号-1</a> |
<span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/SaintIC/Mogege target=_blank rel="external nofollow">Mogege</a></span>
<span>| <a href=https://www.foreverblog.cn/go.html target=_blank title=穿梭虫洞-随机访问十年之约友链博客>虫洞</span></div></footer><script defer src=/js/vendor_main.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script>
<script>pangu.spacingPage()</script><script defer src=https://blog.saintic.com/js/my.js></script></div></body></html>