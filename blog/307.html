<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=author content="Hiroshi.tao"><meta name=description content="一念博客，陶先森の博客，IT博客，技术记录与分享，开源项目与文档"><meta name=keywords content="SaintIC,Hiroshi.tao,Blog,博客,Linux,DevOps,sys,python,go,js,vue,flask,picbed,sapic,Flask-PluginKit,rtfd"><link rel=prev href=https://blog.saintic.com/blog/308.html><link rel=next href=https://blog.saintic.com/blog/309.html><link rel=canonical href=https://blog.saintic.com/blog/307.html><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>二进制方式部署k8s（v1.18 + containerd） | 一念博客</title><meta name=title content="二进制方式部署k8s（v1.18 + containerd） | 一念博客"><link rel=stylesheet href=/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.saintic.com"},"articleSection":"blog","name":"二进制方式部署k8s（v1.18 \u002b containerd）","headline":"二进制方式部署k8s（v1.18 \u002b containerd）","description":"前言 目的：以二进制方式部署实验用途的kubernetes集群 说明：实验性记录，无高可用，etcd亦单机版无证书模式，单主两节点 系统：Cent","inLanguage":"zh-cn","author":"Hiroshi.tao","creator":"Hiroshi.tao","publisher":"Hiroshi.tao","accountablePerson":"Hiroshi.tao","copyrightHolder":"Hiroshi.tao","copyrightYear":"2021","datePublished":"2021-09-24 19:26:00 \u002b0800 \u002b0800","dateModified":"2021-09-24 19:26:00 \u002b0800 \u002b0800","url":"https:\/\/blog.saintic.com\/blog\/307.html","wordCount":"4235","keywords":["go","k8s","docker","一念博客"]}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-back2home-logo"><span class=logo_mark>>$</span>
<a href=https://blog.saintic.com><span class=logo_text>cd /home/</span>
<span class=logo_cursor></span></a></div><div class=navbar-right><span class=menu><a class=menu-item href=/blog.html title>Blog</a>
<a class=menu-item href=/note.html title>Note</a>
<a class=menu-item href=/categories.html title>Categories</a>
<a class=menu-item href=/tags.html title>Tags</a>
<a class=menu-item href=/link.html title>Links</a>
<a class=menu-item href="https://www.baidu.com/s?wd=site:blog.saintic.com+" title>Baidu</a>
<a class=menu-item href="https://www.google.com/search?q=site:blog.saintic.com+" title>Google</a>
<a class=menu-item href=/about.html title=About>About</a>
<span class=divide></span>
<a href=javascript:void(0); class=theme-switch><i class="saintic-icon saintic-icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://blog.saintic.com>一念博客</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="saintic-icon saintic-icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=/blog.html title><h3>Blog</h3><div class=menu-active></div></a><a class=menu-item href=/note.html title><h3>Note</h3><div class=menu-active></div></a><a class=menu-item href=/categories.html title><h3>Categories</h3><div class=menu-active></div></a><a class=menu-item href=/tags.html title><h3>Tags</h3><div class=menu-active></div></a><a class=menu-item href=/link.html title><h3>Links</h3><div class=menu-active></div></a><a class=menu-item href="https://www.baidu.com/s?wd=site:blog.saintic.com+" title><h3>Baidu</h3><div class=menu-active></div></a><a class=menu-item href="https://www.google.com/search?q=site:blog.saintic.com+" title><h3>Google</h3><div class=menu-active></div></a><a class=menu-item href=/about.html title=About><h3>About</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><div class=toc><div class=page-header><strong>- 目录 -</strong></div><div id=page-scrollspy class=toc-nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e5%89%8d%e8%a8%80>前言</a></li></ul></ul><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e5%9c%a8master%e6%93%8d%e4%bd%9c>在Master操作</a></li></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#1-%e5%ae%89%e8%a3%85etcd>1. 安装etcd</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#2-%e5%ae%89%e8%a3%85cfssl%e8%af%81%e4%b9%a6%e7%94%9f%e6%88%90%e5%b7%a5%e5%85%b7>2. 安装cfssl证书生成工具</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#3-%e7%94%9f%e6%88%90k8s%e8%af%81%e4%b9%a6>3. 生成k8s证书</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#4-%e4%b8%8b%e8%bd%bd%e5%ae%89%e8%a3%85kubernetes%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%8f%af%e6%89%a7%e8%a1%8c%e7%a8%8b%e5%ba%8f>4. 下载安装kubernetes二进制可执行程序</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#5-%e9%83%a8%e7%bd%b2kube-apiserver%e7%bb%84%e4%bb%b6>5. 部署kube-apiserver组件</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e5%a4%8d%e5%88%b6%e8%af%81%e4%b9%a6>复制证书</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e5%90%af%e7%94%a8-tls-bootstrapping-%e6%9c%ba%e5%88%b6>启用 TLS Bootstrapping 机制</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#systemd%e7%ae%a1%e7%90%86apiserver>systemd管理apiserver</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e6%8e%88%e6%9d%83kubelet-bootstrap%e7%94%a8%e6%88%b7%e5%85%81%e8%ae%b8%e8%af%b7%e6%b1%82%e8%af%81%e4%b9%a6>授权kubelet-bootstrap用户允许请求证书</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#6-%e9%83%a8%e7%bd%b2kube-controller-manager%e7%bb%84%e4%bb%b6>6. 部署kube-controller-manager组件</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#systemd%e7%ae%a1%e7%90%86controller-manager>systemd管理controller-manager</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#7-%e9%83%a8%e7%bd%b2kube-scheduler%e7%bb%84%e4%bb%b6>7. 部署kube-scheduler组件</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#systemd%e7%ae%a1%e7%90%86scheduler>systemd管理scheduler</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#8-%e6%9f%a5%e7%9c%8b%e9%9b%86%e7%be%a4%e7%8a%b6%e6%80%81>8. 查看集群状态</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#9-%e5%9c%a8master%e4%b8%8a%e5%87%86%e5%a4%87worker%e7%8e%af%e5%a2%83%e6%89%80%e9%9c%80>9. 在Master上准备Worker环境所需</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e7%94%9f%e6%88%90kubelet%e5%88%9d%e6%ac%a1%e5%8a%a0%e5%85%a5%e9%9b%86%e7%be%a4%e5%bc%95%e5%af%bckubeconfig%e6%96%87%e4%bb%b6>生成kubelet初次加入集群引导kubeconfig文件</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e7%94%9f%e6%88%90kube-proxykubeconfig%e6%96%87%e4%bb%b6>生成kube-proxy.kubeconfig文件</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e5%9c%a8woker-node%e6%93%8d%e4%bd%9c>在Woker Node操作</a></li></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#1-%e5%ae%89%e8%a3%85containerd>1. 安装containerd</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#2-%e9%83%a8%e7%bd%b2kubelet>2. 部署kubelet</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e9%85%8d%e7%bd%ae%e5%8f%82%e6%95%b0%e6%96%87%e4%bb%b6>配置参数文件</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#systemd%e7%ae%a1%e7%90%86kubelet>systemd管理kubelet</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e6%89%b9%e5%87%86kubelet%e8%af%81%e4%b9%a6%e7%94%b3%e8%af%b7%e5%b9%b6%e5%8a%a0%e5%85%a5%e9%9b%86%e7%be%a4>批准kubelet证书申请并加入集群</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#3-%e9%83%a8%e7%bd%b2kube-proxy>3. 部署kube-proxy</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e9%85%8d%e7%bd%ae%e5%8f%82%e6%95%b0%e6%96%87%e4%bb%b6-1>配置参数文件</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#systemd%e7%ae%a1%e7%90%86kube-proxy>systemd管理kube-proxy</a></li></ul></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#4-%e5%ae%89%e8%a3%85cni-plugins>4. 安装cni-plugins</a></li></ul></ul></ul><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e9%83%a8%e7%bd%b2cni%e7%bd%91%e7%bb%9c%e5%8f%8a%e5%85%b6%e4%bb%96%e5%8f%af%e9%80%89%e7%bb%84%e4%bb%b6%e5%9c%a8master%e4%b8%8a%e6%93%8d%e4%bd%9c>部署CNI网络及其他可选组件（在Master上操作）</a></li></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e9%83%a8%e7%bd%b2flannel%e7%bd%91%e7%bb%9c%e7%bb%84%e4%bb%b6>部署flannel网络组件</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e6%8e%88%e6%9d%83apiserver%e8%ae%bf%e9%97%aekubelet>授权apiserver访问kubelet</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e9%83%a8%e7%bd%b2coredns%e7%bb%84%e4%bb%b6>部署CoreDNS组件</a></li></ul></ul></ul><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e5%ae%8c%e7%bb%93>完结</a></li></ul></ul></div></div><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">二进制方式部署k8s（v1.18 + containerd）</h1><div class=post-meta>Written by <a itemprop=name href=https://blog.saintic.com rel=author>Hiroshi.tao</a> with ♥
<span class=post-time>on <time datetime=2021-09-24 itemprop=datePublished>September 24, 2021</time></span>
in
<i class="saintic-icon saintic-icon-folder"></i>
<span class=post-category><a href=https://blog.saintic.com/categories/%E8%BF%90%E7%BB%B4.html>运维</a></span>
<span class=post-word-count>4235 words</span></div></header><div class=post-content><h2 id=前言>前言</h2><p>目的：以二进制方式部署实验用途的kubernetes集群</p><p>说明：实验性记录，无高可用，etcd亦单机版无证书模式，单主两节点</p><p>系统：CentOS 7.2（阿里云ECS，无安全组、iptables，禁用selinux、swap，时间同步，2C 4G）</p><p>服务器规划（写入到各节点hosts）：</p><table><thead><tr><th>主机名</th><th>IP</th><th>组件</th></tr></thead><tbody><tr><td>k8s-master</td><td>172.17.89.23</td><td>apiserver，controller-manager，scheduler，etcd</td></tr><tr><td>k8s-node7</td><td>172.17.89.17</td><td>kubelet，kube-proxy，containerd</td></tr><tr><td>k8s-node8</td><td>172.17.89.7</td><td>kubelet，kube-proxy，containerd</td></tr></tbody></table><p>网络规划：</p><ul><li><p>Service: 10.0.0.0/24</p></li><li><p>Pod: 10.244.0.0/16</p></li></ul><p>软件版本：</p><ul><li>Kubernetes 1.18</li><li>containerd 1.4</li><li>etcd 3.3</li><li>cfssl 1.5</li><li>flannel 0.13</li><li>cni-plugins 0.9</li></ul><p>增加内核参数，将桥接的IPv4流量传递到iptables的链（所有节点）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /etc/sysctl.d/k8s.conf <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.ip_forward = 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sysctl -p /etc/sysctl.d/k8s.conf
</span></span></code></pre></div><p>以下操作，代码区域 <code>$</code> 符号表示有输出或换行（无它时表示纯命令），<code>#</code>表示注释，一般情况下以root身份操作。</p><h2 id=在master操作>在Master操作</h2><h3 id=1-安装etcd>1. 安装etcd</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ yum install etcd
</span></span><span style=display:flex><span>$ systemctl start etcd
</span></span><span style=display:flex><span>$ systemctl enable etcd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ etcd --version
</span></span><span style=display:flex><span>etcd Version: 3.3.11
</span></span><span style=display:flex><span>Git SHA: 2cf9e51
</span></span><span style=display:flex><span>Go Version: go1.10.3
</span></span><span style=display:flex><span>Go OS/Arch: linux/amd64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ etcdctl cluster-health
</span></span><span style=display:flex><span>member 8e9e05c52164694d is healthy: got healthy result from http://localhost:2379
</span></span><span style=display:flex><span>cluster is healthy
</span></span></code></pre></div><p>是的，单机版etcd，监听<code>127.0.0.1:2379</code>，无证书认证。</p><h3 id=2-安装cfssl证书生成工具>2. 安装cfssl证书生成工具</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget -c https://static.saintic.com/download/k8s/cfssl-R1.2.tar.gz
</span></span><span style=display:flex><span>tar zxf cfssl-R1.2.tar.gz
</span></span><span style=display:flex><span>chmod +x cfssl cfssljson cfssl-certinfo
</span></span><span style=display:flex><span>mv cfssl cfssljson cfssl-certinfo /usr/bin/
</span></span></code></pre></div><h3 id=3-生成k8s证书>3. 生成k8s证书</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 自签证书颁发机构（CA）</span>
</span></span><span style=display:flex><span>$ mkdir -p ~/TLS/k8s <span style=color:#f92672>&amp;&amp;</span> cd ~/TLS/k8s
</span></span><span style=display:flex><span>$ cat &gt; ca-config.json <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;signing&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;default&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;expiry&#34;: &#34;87600h&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;profiles&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;kubernetes&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         &#34;expiry&#34;: &#34;87600h&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         &#34;usages&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;signing&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;key encipherment&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;server auth&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;client auth&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat &gt; ca-csr.json <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;CN&#34;: &#34;kubernetes&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;key&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;size&#34;: 2048
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;names&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;L&#34;: &#34;Beijing&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;ST&#34;: &#34;Beijing&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;O&#34;: &#34;k8s&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> generating a new CA key and certificate from CSR
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> generate received request
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> received CSR
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> generating key: rsa-2048
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> encoded CSR
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> signed certificate with serial number <span style=color:#ae81ff>218586274008070489012647351630930893980576584553</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ls *pem
</span></span><span style=display:flex><span>ca-key.pem  ca.pem
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用自签CA签发kube-apiserver HTTPS证书</span>
</span></span><span style=display:flex><span><span style=color:#75715e># hosts字段中IP为所有Master/LB/VIP IP，一个都不能少！为了方便后期扩容可以写几个预留的IP</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 注意也要加上Service网络范围的第一个IP，比如本示例是10.0.0.1</span>
</span></span><span style=display:flex><span>$ cat &gt; server-csr.json <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;CN&#34;: &#34;kubernetes&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;hosts&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;10.0.0.1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;127.0.0.1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;172.17.89.23&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;172.17.89.17&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;172.17.89.7&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;172.17.89.10&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;kubernetes&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;kubernetes.default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;kubernetes.default.svc&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;kubernetes.default.svc.cluster&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;kubernetes.default.svc.cluster.local&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;key&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;size&#34;: 2048
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;names&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;O&#34;: &#34;k8s&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cfssl gencert -ca<span style=color:#f92672>=</span>ca.pem -ca-key<span style=color:#f92672>=</span>ca-key.pem -config<span style=color:#f92672>=</span>ca-config.json -profile<span style=color:#f92672>=</span>kubernetes server-csr.json | cfssljson -bare server
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> generate received request
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> received CSR
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> generating key: rsa-2048
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> encoded CSR
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> signed certificate with serial number <span style=color:#ae81ff>276237244257869550803211619152022588342922126725</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ls server*pem
</span></span><span style=display:flex><span>server-key.pem  server.pem
</span></span></code></pre></div><h3 id=4-下载安装kubernetes二进制可执行程序>4. 下载安装kubernetes二进制可执行程序</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd /usr/local/src
</span></span><span style=display:flex><span>wget -c https://static.saintic.com/download/k8s/kubernetes-server-linux-amd64.tar.gz
</span></span><span style=display:flex><span>tar zxf kubernetes-server-linux-amd64.tar.gz
</span></span><span style=display:flex><span>cd kubernetes/server/bin
</span></span><span style=display:flex><span>mkdir -p /opt/k8s/<span style=color:#f92672>{</span>bin,cfg,ssl,logs<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>cp kube-apiserver kube-scheduler kube-controller-manager /opt/k8s/bin
</span></span><span style=display:flex><span>cp kubectl /usr/bin/
</span></span></code></pre></div><h3 id=5-部署kube-apiserver组件>5. 部署kube-apiserver组件</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /opt/k8s/cfg/kube-apiserver.conf <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>KUBE_APISERVER_OPTS=&#34;--logtostderr=false \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--v=2 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--log-dir=/opt/k8s/logs \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--etcd-servers=http://localhost:2379 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--bind-address=172.17.89.23 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--secure-port=6443 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--advertise-address=172.17.89.23 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--allow-privileged=true \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--service-cluster-ip-range=10.0.0.0/24 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--authorization-mode=RBAC,Node \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--enable-bootstrap-token-auth=true \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--token-auth-file=/opt/k8s/cfg/token.csv \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--service-node-port-range=30000-32767 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--kubelet-client-certificate=/opt/k8s/ssl/server.pem \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--kubelet-client-key=/opt/k8s/ssl/server-key.pem \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--tls-cert-file=/opt/k8s/ssl/server.pem \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--tls-private-key-file=/opt/k8s/ssl/server-key.pem \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--client-ca-file=/opt/k8s/ssl/ca.pem \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--service-account-key-file=/opt/k8s/ssl/ca-key.pem \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--audit-log-maxage=30 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--audit-log-maxbackup=3 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--audit-log-maxsize=100 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--audit-log-path=/opt/k8s/logs/k8s-audit.log&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>配置说明：</p><p>&ndash;etcd-servers：etcd地址</p><p>&ndash;bind-address：监听地址</p><p>&ndash;advertise-address：集群通告地址</p><p>&ndash;service-cluster-ip-range：Service虚拟IP地址段</p><p>&ndash;enable-admission-plugins：准入控制模块</p><p>&ndash;authorization-mode：认证授权，启用RBAC授权和节点自管理</p><p>&ndash;enable-bootstrap-token-auth：启用TLS bootstrap机制</p><p>&ndash;token-auth-file：bootstrap token文件</p><h4 id=复制证书>复制证书</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp ~/TLS/k8s/ca*pem ~/TLS/k8s/server*pem /opt/k8s/ssl/
</span></span></code></pre></div><h4 id=启用-tls-bootstrapping-机制>启用 TLS Bootstrapping 机制</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 生成token</span>
</span></span><span style=display:flex><span>$ head -c <span style=color:#ae81ff>16</span> /dev/urandom | od -An -t x | tr -d <span style=color:#e6db74>&#39; &#39;</span>
</span></span><span style=display:flex><span>cf2cdbdd07d06094e598d83d0b89006b
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 格式：token，用户名，UID，用户组</span>
</span></span><span style=display:flex><span>$ cat &gt; /opt/k8s/cfg/token.csv <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>cf2cdbdd07d06094e598d83d0b89006b,kubelet-bootstrap,10001,&#34;system:node-bootstrapper&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><h4 id=systemd管理apiserver>systemd管理apiserver</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /lib/systemd/system/kube-apiserver.service <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Unit]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Description=Kubernetes API Server
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Service]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EnvironmentFile=/opt/k8s/cfg/kube-apiserver.conf
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecStart=/opt/k8s/bin/kube-apiserver $KUBE_APISERVER_OPTS
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Restart=on-failure
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Install]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WantedBy=multi-user.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl enable kube-apiserver
</span></span><span style=display:flex><span>systemctl start kube-apiserver
</span></span></code></pre></div><h4 id=授权kubelet-bootstrap用户允许请求证书>授权kubelet-bootstrap用户允许请求证书</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create clusterrolebinding kubelet-bootstrap <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --clusterrole<span style=color:#f92672>=</span>system:node-bootstrapper <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --user<span style=color:#f92672>=</span>kubelet-bootstrap
</span></span></code></pre></div><h3 id=6-部署kube-controller-manager组件>6. 部署kube-controller-manager组件</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /opt/k8s/cfg/kube-controller-manager.conf <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>KUBE_CONTROLLER_MANAGER_OPTS=&#34;--logtostderr=false \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--v=2 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--log-dir=/opt/k8s/logs \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--leader-elect=true \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--master=127.0.0.1:8080 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--bind-address=127.0.0.1 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--allocate-node-cidrs=true \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--cluster-cidr=10.244.0.0/16 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--service-cluster-ip-range=10.0.0.0/24 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--cluster-signing-cert-file=/opt/k8s/ssl/ca.pem \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--cluster-signing-key-file=/opt/k8s/ssl/ca-key.pem  \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--root-ca-file=/opt/k8s/ssl/ca.pem \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--service-account-private-key-file=/opt/k8s/ssl/ca-key.pem \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--experimental-cluster-signing-duration=87600h0m0s&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><h4 id=systemd管理controller-manager>systemd管理controller-manager</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /lib/systemd/system/kube-controller-manager.service <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Unit]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Description=Kubernetes Controller Manager
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Service]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EnvironmentFile=/opt/k8s/cfg/kube-controller-manager.conf
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecStart=/opt/k8s/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Restart=on-failure
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Install]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WantedBy=multi-user.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl start kube-controller-manager
</span></span><span style=display:flex><span>systemctl enable kube-controller-manager
</span></span></code></pre></div><h3 id=7-部署kube-scheduler组件>7. 部署kube-scheduler组件</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /opt/k8s/cfg/kube-scheduler.conf <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>KUBE_SCHEDULER_OPTS=&#34;--logtostderr=false \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--v=2 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--log-dir=/opt/k8s/logs \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--leader-elect \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--master=127.0.0.1:8080 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--bind-address=127.0.0.1&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><h4 id=systemd管理scheduler>systemd管理scheduler</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /usr/lib/systemd/system/kube-scheduler.service <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Unit]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Description=Kubernetes Scheduler
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Service]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EnvironmentFile=/opt/k8s/cfg/kube-scheduler.conf
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecStart=/opt/k8s/bin/kube-scheduler $KUBE_SCHEDULER_OPTS
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Restart=on-failure
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Install]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WantedBy=multi-user.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl start kube-scheduler
</span></span><span style=display:flex><span>systemctl enable kube-scheduler
</span></span></code></pre></div><h3 id=8-查看集群状态>8. 查看集群状态</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 如下输出说明Master节点组件运行正常</span>
</span></span><span style=display:flex><span>$ kubectl get cs
</span></span><span style=display:flex><span>NAME                 STATUS    MESSAGE             ERROR
</span></span><span style=display:flex><span>scheduler            Healthy   ok                  
</span></span><span style=display:flex><span>etcd-0               Healthy   <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;health&#34;</span>:<span style=color:#e6db74>&#34;true&#34;</span><span style=color:#f92672>}</span>   
</span></span><span style=display:flex><span>controller-manager   Healthy   ok  
</span></span></code></pre></div><h3 id=9-在master上准备worker环境所需>9. 在Master上准备Worker环境所需</h3><h4 id=生成kubelet初次加入集群引导kubeconfig文件>生成kubelet初次加入集群引导kubeconfig文件</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ KUBE_CONFIG<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/opt/k8s/cfg/bootstrap.kubeconfig&#34;</span>
</span></span><span style=display:flex><span>$ KUBE_APISERVER<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://172.17.89.23:6443&#34;</span>
</span></span><span style=display:flex><span>$ TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cf2cdbdd07d06094e598d83d0b89006b&#34;</span>   <span style=color:#75715e># 与token.csv里保持一致</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成 kubelet bootstrap kubeconfig 配置文件</span>
</span></span><span style=display:flex><span>$ kubectl config set-cluster kubernetes <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --certificate-authority<span style=color:#f92672>=</span>/opt/k8s/ssl/ca.pem <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --embed-certs<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --server<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>KUBE_APISERVER<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --kubeconfig<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>KUBE_CONFIG<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>$ kubectl config set-credentials <span style=color:#e6db74>&#34;kubelet-bootstrap&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --token<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>TOKEN<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --kubeconfig<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>KUBE_CONFIG<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>$ kubectl config set-context default <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --cluster<span style=color:#f92672>=</span>kubernetes <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;kubelet-bootstrap&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --kubeconfig<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>KUBE_CONFIG<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>$ kubectl config use-context default --kubeconfig<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>KUBE_CONFIG<span style=color:#e6db74>}</span>
</span></span></code></pre></div><h4 id=生成kube-proxykubeconfig文件>生成kube-proxy.kubeconfig文件</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cd ~/TLS/k8s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建证书请求文件</span>
</span></span><span style=display:flex><span>$ cat &gt; kube-proxy-csr.json <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;CN&#34;: &#34;system:kube-proxy&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;hosts&#34;: [],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;key&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;size&#34;: 2048
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;names&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;L&#34;: &#34;BeiJing&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;ST&#34;: &#34;BeiJing&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;O&#34;: &#34;k8s&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成证书</span>
</span></span><span style=display:flex><span>$ cfssl gencert -ca<span style=color:#f92672>=</span>ca.pem -ca-key<span style=color:#f92672>=</span>ca-key.pem -config<span style=color:#f92672>=</span>ca-config.json -profile<span style=color:#f92672>=</span>kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成kubeconfig文件</span>
</span></span><span style=display:flex><span>$ KUBE_CONFIG<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/opt/k8s/cfg/kube-proxy.kubeconfig&#34;</span>
</span></span><span style=display:flex><span>$ KUBE_APISERVER<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://172.17.89.23:6443&#34;</span> <span style=color:#75715e># 如同一终端可忽略，上一步已设置</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl config set-cluster kubernetes <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --certificate-authority<span style=color:#f92672>=</span>/opt/k8s/ssl/ca.pem <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --embed-certs<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --server<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>KUBE_APISERVER<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --kubeconfig<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>KUBE_CONFIG<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>$ kubectl config set-credentials kube-proxy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --client-certificate<span style=color:#f92672>=</span>./kube-proxy.pem <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --client-key<span style=color:#f92672>=</span>./kube-proxy-key.pem <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --embed-certs<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --kubeconfig<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>KUBE_CONFIG<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>$ kubectl config set-context default <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --cluster<span style=color:#f92672>=</span>kubernetes <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --user<span style=color:#f92672>=</span>kube-proxy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --kubeconfig<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>KUBE_CONFIG<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>$ kubectl config use-context default --kubeconfig<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>KUBE_CONFIG<span style=color:#e6db74>}</span>
</span></span></code></pre></div><hr><h2 id=在woker-node操作>在Woker Node操作</h2><p>Master不作为Worker使用，以下操作在k8s-node7节点上，资源受限也可以在Master上。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir -p /opt/k8s/<span style=color:#f92672>{</span>bin,cfg,ssl,logs<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 把Master节点上的 kubernetes/server/bin/ 下的 kubelet 和 kube-proxy 同步到Worker上</span>
</span></span><span style=display:flex><span>$ cp kubelet kube-proxy /opt/k8s/bin/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 把Master节点上生成的Node所需文件（在 /opt/k8s/cfg/ 下）同步到Worker上</span>
</span></span><span style=display:flex><span>$ cp bootstrap.kubeconfig kube-proxy.kubeconfig /opt/k8s/cfg/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 把Master节点上的ca.pem（在 /opt/k8s/ssl/ 下）同步到Worker上</span>
</span></span><span style=display:flex><span>$ cp ca.pem /opt/k8s/ssl/
</span></span></code></pre></div><h3 id=1-安装containerd>1. 安装containerd</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install -y yum-utils
</span></span><span style=display:flex><span>yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
</span></span><span style=display:flex><span>yum install -y containerd.io
</span></span><span style=display:flex><span>containerd config default | tee /etc/containerd/config.toml
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s#k8s.gcr.io/pause#docker.io/staugur/pause#&#39;</span> /etc/containerd/config.toml
</span></span><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl start containerd
</span></span><span style=display:flex><span>systemctl enable containerd
</span></span></code></pre></div><p>//（可选）安装crictl工具</p><h3 id=2-部署kubelet>2. 部署kubelet</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /opt/k8s/cfg/kubelet.conf <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>KUBELET_OPTS=&#34;--logtostderr=false \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--v=2 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--log-dir=/opt/k8s/logs \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--hostname-override=k8s-node7 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--kubeconfig=/opt/k8s/cfg/kubelet.kubeconfig \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--bootstrap-kubeconfig=/opt/k8s/cfg/bootstrap.kubeconfig \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--config=/opt/k8s/cfg/kubelet-config.yml \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--cert-dir=/opt/k8s/ssl \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--pod-infra-container-image=docker.io/staugur/pause:3.2 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--container-runtime=remote \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--container-runtime-endpoint=unix:///var/run/containerd/containerd.sock&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>参数说明：</p><p>&ndash;hostname-override：显示名称，集群中唯一</p><p>&ndash;kubeconfig：空路径，会自动生成（即TLS bootstraping流程，批准后生成），用于连接apiserver</p><p>&ndash;bootstrap-kubeconfig：首次启动向apiserver申请证书</p><p>&ndash;config：配置参数文件</p><p>&ndash;cert-dir：kubelet证书生成目录</p><p>&ndash;pod-infra-container-image：管理Pod网络容器的镜像</p><p>&ndash;container-runtime：设定容器运行时，目前默认还是docker，需要改为remote</p><p>&ndash;container-runtime-endpoint：远程运行时的端点，即containerd的sock路径</p><h4 id=配置参数文件>配置参数文件</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /opt/k8s/cfg/kubelet-config.yml <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: KubeletConfiguration
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: kubelet.config.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>address: 0.0.0.0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>port: 10250
</span></span></span><span style=display:flex><span><span style=color:#e6db74>readOnlyPort: 10255
</span></span></span><span style=display:flex><span><span style=color:#e6db74>cgroupDriver: cgroupfs
</span></span></span><span style=display:flex><span><span style=color:#e6db74>clusterDNS:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- 10.0.0.2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>clusterDomain: cluster.local 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>failSwapOn: false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>authentication:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  anonymous:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    enabled: false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  webhook:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    cacheTTL: 2m0s
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    enabled: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  x509:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    clientCAFile: /opt/k8s/ssl/ca.pem 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>authorization:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  mode: Webhook
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  webhook:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    cacheAuthorizedTTL: 5m0s
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    cacheUnauthorizedTTL: 30s
</span></span></span><span style=display:flex><span><span style=color:#e6db74>evictionHard:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  imagefs.available: 15%
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  memory.available: 100Mi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  nodefs.available: 10%
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  nodefs.inodesFree: 5%
</span></span></span><span style=display:flex><span><span style=color:#e6db74>maxOpenFiles: 1000000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>maxPods: 110
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>参数说明：</p><p>clusterDNS：根据实际修改，一般是Service网络第二个IP</p><h4 id=systemd管理kubelet>systemd管理kubelet</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /lib/systemd/system/kubelet.service <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Unit]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Description=Kubernetes Kubelet
</span></span></span><span style=display:flex><span><span style=color:#e6db74>After=docker.service
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Service]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EnvironmentFile=/opt/k8s/cfg/kubelet.conf
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecStart=/opt/k8s/bin/kubelet $KUBELET_OPTS
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Restart=on-failure
</span></span></span><span style=display:flex><span><span style=color:#e6db74>LimitNOFILE=65536
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Install]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WantedBy=multi-user.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl start kubelet
</span></span><span style=display:flex><span>systemctl enable kubelet
</span></span></code></pre></div><h4 id=批准kubelet证书申请并加入集群>批准kubelet证书申请并加入集群</h4><p><b>这一步切换到Master节点操作！</b></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看kubelet证书请求</span>
</span></span><span style=display:flex><span>$ kubectl get csr
</span></span><span style=display:flex><span>NAME           AGE     SIGNERNAME                                    REQUESTOR           CONDITION
</span></span><span style=display:flex><span>node-csr-xxx   2m26s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 批准申请</span>
</span></span><span style=display:flex><span>$ kubectl certificate approve node-csr-xxx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看节点（由于网络插件还没有部署，节点会没有准备就绪 NotReady）</span>
</span></span><span style=display:flex><span>$ kubectl get node
</span></span><span style=display:flex><span>NAME        STATUS     ROLES    AGE    VERSION
</span></span><span style=display:flex><span>k8s-node7   NotReady   &lt;none&gt;   3m6s   v1.18.3
</span></span></code></pre></div><h3 id=3-部署kube-proxy>3. 部署kube-proxy</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /opt/k8s/cfg/kube-proxy.conf <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>KUBE_PROXY_OPTS=&#34;--logtostderr=false \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--v=2 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--log-dir=/opt/k8s/logs \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--config=/opt/k8s/cfg/kube-proxy-config.yml&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><h4 id=配置参数文件-1>配置参数文件</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /opt/k8s/cfg/kube-proxy-config.yml <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: KubeProxyConfiguration
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>bindAddress: 0.0.0.0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metricsBindAddress: 0.0.0.0:10249
</span></span></span><span style=display:flex><span><span style=color:#e6db74>clientConnection:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  kubeconfig: /opt/k8s/cfg/kube-proxy.kubeconfig
</span></span></span><span style=display:flex><span><span style=color:#e6db74>hostnameOverride: k8s-node7
</span></span></span><span style=display:flex><span><span style=color:#e6db74>clusterCIDR: 10.244.0.0/16
</span></span></span><span style=display:flex><span><span style=color:#e6db74>mode: iptables
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>参数说明：</p><p>hostnameOverride：显示名称，集群中唯一</p><p>clusterCIDR：特别说明这个参数，</p><ul><li><p>官网描述是：clusterCIDR is the CIDR range of the pods in the cluster，
它是集群中 Pod 的 CIDR 范围，但是很多文档变成了 Service 的 CIDR 范围。</p></li><li><p>这在ipvs模式下有问题的，node/pod访问默认Service ClusterIP超时，比如按照flannel网络，
死活起不来，pod状态是CrashLoopBackOff，错误日志是
<code>failed to create subnetmanager: error retrieving pod spec, dial tcp 10.0.0.1:443 i/o timeout</code></p></li></ul><h4 id=systemd管理kube-proxy>systemd管理kube-proxy</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /lib/systemd/system/kube-proxy.service <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Unit]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Description=Kubernetes Proxy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>After=network.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Service]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EnvironmentFile=/opt/k8s/cfg/kube-proxy.conf
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecStart=/opt/k8s/bin/kube-proxy $KUBE_PROXY_OPTS
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Restart=on-failure
</span></span></span><span style=display:flex><span><span style=color:#e6db74>LimitNOFILE=65536
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Install]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WantedBy=multi-user.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl start kube-proxy
</span></span><span style=display:flex><span>systemctl enable kube-proxy
</span></span></code></pre></div><h3 id=4-安装cni-plugins>4. 安装cni-plugins</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /opt/cni/bin
</span></span><span style=display:flex><span>version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.9.1&#34;</span>
</span></span><span style=display:flex><span>wget -c https://github.com/containernetworking/plugins/releases/download/v<span style=color:#e6db74>${</span>version<span style=color:#e6db74>}</span>/cni-plugins-linux-amd64-v<span style=color:#e6db74>${</span>version<span style=color:#e6db74>}</span>.tgz
</span></span><span style=display:flex><span>tar zxf cni-plugins-linux-amd64-v<span style=color:#e6db74>${</span>version<span style=color:#e6db74>}</span>.tgz -C /opt/cni/bin/
</span></span></code></pre></div><p>至此，Worker节点大致是这样，增加节点按照本部分内容操作即可。</p><p>//（省略）依次安装k8s-node8节点，注意更改主机名（hostname-override）</p><hr><h2 id=部署cni网络及其他可选组件在master上操作>部署CNI网络及其他可选组件（在Master上操作）</h2><h3 id=部署flannel网络组件>部署flannel网络组件</h3><p>使用flannel，部署到pod中（使用v0.13，注意flannel默认网络与上述集群网络一致）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>KUBE_FLANNEL<span style=color:#f92672>=</span>https://raw.githubusercontent.com/flannel-io/flannel/v0.13.0/Documentation/kube-flannel.yml
</span></span><span style=display:flex><span>kubectl apply -f $KUBE_FLANNEL
</span></span></code></pre></div><p>Pod部署完成后，<code>kubectl get node</code>状态应该是Ready</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get node
</span></span><span style=display:flex><span>NAME        STATUS   ROLES    AGE   VERSION
</span></span><span style=display:flex><span>k8s-node7   Ready    &lt;none&gt;   13m   v1.18.3
</span></span></code></pre></div><h3 id=授权apiserver访问kubelet>授权apiserver访问kubelet</h3><p>以便apiserver可以调用node的kubelet接口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 可以放到yaml集中目录</span>
</span></span><span style=display:flex><span>$ cat &gt; apiserver-to-kubelet-rbac.yaml <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: ClusterRole
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    rbac.authorization.kubernetes.io/autoupdate: &#34;true&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  labels:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    kubernetes.io/bootstrapping: rbac-defaults
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: system:kube-apiserver-to-kubelet
</span></span></span><span style=display:flex><span><span style=color:#e6db74>rules:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - apiGroups:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    resources:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - nodes/proxy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - nodes/stats
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - nodes/log
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - nodes/spec
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - nodes/metrics
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - pods/log
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    verbs:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>---
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: ClusterRoleBinding
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: system:kube-apiserver
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  namespace: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>roleRef:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  apiGroup: rbac.authorization.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  kind: ClusterRole
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: system:kube-apiserver-to-kubelet
</span></span></span><span style=display:flex><span><span style=color:#e6db74>subjects:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  - apiGroup: rbac.authorization.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    kind: User
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    name: kubernetes
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl apply -f apiserver-to-kubelet-rbac.yaml
</span></span></code></pre></div><h3 id=部署coredns组件>部署CoreDNS组件</h3><p>CoreDNS用于集群内部Service名称解析。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安装依赖 jq 命令（coredns deploy.sh脚本生成yaml用到此命令）</span>
</span></span><span style=display:flex><span>$ yum install jq -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 下载 CoreDNS 部署项目</span>
</span></span><span style=display:flex><span>$ git clone https://github.com/coredns/deployment.git
</span></span><span style=display:flex><span>$ cd coredns/deployment/kubernetes
</span></span><span style=display:flex><span>$ ./deploy.sh -i 10.0.0.2 | kubectl apply -f -
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看结果</span>
</span></span><span style=display:flex><span>$ kubectl get svc -n kube-system -o wide
</span></span><span style=display:flex><span>NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>                  AGE     SELECTOR
</span></span><span style=display:flex><span>kube-dns   ClusterIP   10.0.0.2     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   3m26s   k8s-app<span style=color:#f92672>=</span>kube-dns
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get pods -n kube-system -l k8s-app<span style=color:#f92672>=</span>kube-dns -o wide
</span></span><span style=display:flex><span>NAME                      READY   STATUS    RESTARTS   AGE     IP           NODE        NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>coredns-6ff445f54-cg2zj   1/1     Running   <span style=color:#ae81ff>0</span>          9m16s   10.244.0.2   k8s-node7   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>默认情况下是自动获取kube-dns的集群ip的，但是由于没有部署kube-dns所以只能手动指定一个
集群ip（前面kubelet规划的IP地址），否则会报错。</p><h2 id=完结>完结</h2><p>目前整体文件结构、服务状态如下：</p><ul><li>Master /opt/k8s</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ tree /opt/k8s/
</span></span><span style=display:flex><span>/opt/k8s/
</span></span><span style=display:flex><span>├── bin
</span></span><span style=display:flex><span>│   ├── kube-apiserver
</span></span><span style=display:flex><span>│   ├── kube-controller-manager
</span></span><span style=display:flex><span>│   └── kube-scheduler
</span></span><span style=display:flex><span>├── cfg
</span></span><span style=display:flex><span>│   ├── bootstrap.kubeconfig    <span style=color:#75715e># 实际对Master无用</span>
</span></span><span style=display:flex><span>│   ├── kube-apiserver.conf
</span></span><span style=display:flex><span>│   ├── kube-controller-manager.conf
</span></span><span style=display:flex><span>│   ├── kube-proxy.kubeconfig   <span style=color:#75715e># 实际对Master无用</span>
</span></span><span style=display:flex><span>│   ├── kube-scheduler.conf
</span></span><span style=display:flex><span>│   └── token.csv
</span></span><span style=display:flex><span>├── logs
</span></span><span style=display:flex><span>│   ├── ignore...
</span></span><span style=display:flex><span>└── ssl
</span></span><span style=display:flex><span>    ├── ca-key.pem
</span></span><span style=display:flex><span>    ├── ca.pem
</span></span><span style=display:flex><span>    ├── server-key.pem
</span></span><span style=display:flex><span>    └── server.pem
</span></span></code></pre></div><ul><li>Worker /opt/k8s</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ tree /opt/k8s/
</span></span><span style=display:flex><span>/opt/k8s/
</span></span><span style=display:flex><span>├── bin
</span></span><span style=display:flex><span>│   ├── kubelet
</span></span><span style=display:flex><span>│   └── kube-proxy
</span></span><span style=display:flex><span>├── cfg
</span></span><span style=display:flex><span>│   ├── bootstrap.kubeconfig
</span></span><span style=display:flex><span>│   ├── kubelet.conf
</span></span><span style=display:flex><span>│   ├── kubelet-config.yml
</span></span><span style=display:flex><span>│   ├── kubelet.kubeconfig
</span></span><span style=display:flex><span>│   ├── kube-proxy.conf
</span></span><span style=display:flex><span>│   ├── kube-proxy-config.yml
</span></span><span style=display:flex><span>│   └── kube-proxy.kubeconfig
</span></span><span style=display:flex><span>├── logs
</span></span><span style=display:flex><span>│   └── ignore...
</span></span><span style=display:flex><span>└── ssl
</span></span><span style=display:flex><span>    ├── ca.pem
</span></span><span style=display:flex><span>    ├── kubelet-client-2021-05-11-17-14-05.pem
</span></span><span style=display:flex><span>    ├── kubelet-client-current.pem -&gt; /opt/k8s/ssl/kubelet-client-2021-05-11-17-14-05.pem
</span></span><span style=display:flex><span>    ├── kubelet.crt
</span></span><span style=display:flex><span>    └── kubelet.key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ tree /opt/cni
</span></span><span style=display:flex><span>/opt/cni/
</span></span><span style=display:flex><span>└── bin
</span></span><span style=display:flex><span>    ├── bandwidth
</span></span><span style=display:flex><span>    ├── bridge
</span></span><span style=display:flex><span>    ├── dhcp
</span></span><span style=display:flex><span>    ├── firewall
</span></span><span style=display:flex><span>    ├── flannel
</span></span><span style=display:flex><span>    ├── host-device
</span></span><span style=display:flex><span>    ├── host-local
</span></span><span style=display:flex><span>    ├── ipvlan
</span></span><span style=display:flex><span>    ├── loopback
</span></span><span style=display:flex><span>    ├── macvlan
</span></span><span style=display:flex><span>    ├── portmap
</span></span><span style=display:flex><span>    ├── ptp
</span></span><span style=display:flex><span>    ├── sbr
</span></span><span style=display:flex><span>    ├── static
</span></span><span style=display:flex><span>    ├── tuning
</span></span><span style=display:flex><span>    ├── vlan
</span></span><span style=display:flex><span>    └── vrf
</span></span></code></pre></div><ul><li>Master kubectl get status</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get cs,node -o wide
</span></span><span style=display:flex><span>NAME                                 STATUS    MESSAGE             ERROR
</span></span><span style=display:flex><span>componentstatus/controller-manager   Healthy   ok                  
</span></span><span style=display:flex><span>componentstatus/etcd-0               Healthy   <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;health&#34;</span>:<span style=color:#e6db74>&#34;true&#34;</span><span style=color:#f92672>}</span>   
</span></span><span style=display:flex><span>componentstatus/scheduler            Healthy   ok                  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME             STATUS   ROLES    AGE    VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION              CONTAINER-RUNTIME
</span></span><span style=display:flex><span>node/k8s-node7   Ready    &lt;none&gt;   18h    v1.18.3   172.17.89.17   &lt;none&gt;        CentOS Linux <span style=color:#ae81ff>7</span> <span style=color:#f92672>(</span>Core<span style=color:#f92672>)</span>   3.10.0-514.6.2.el7.x86_64   containerd://1.4.4
</span></span><span style=display:flex><span>node/k8s-node8   Ready    &lt;none&gt;   116m   v1.18.3   172.17.89.7    &lt;none&gt;        CentOS Linux <span style=color:#ae81ff>7</span> <span style=color:#f92672>(</span>Core<span style=color:#f92672>)</span>   3.10.0-514.6.2.el7.x86_64   containerd://1.4.4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get pod -n kube-system -o wide
</span></span><span style=display:flex><span>NAME                      READY   STATUS    RESTARTS   AGE     IP             NODE        NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>coredns-6ff445f54-cg2zj   1/1     Running   <span style=color:#ae81ff>0</span>          9m45s   10.244.0.2     k8s-node7   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-flannel-ds-7cssx     1/1     Running   <span style=color:#ae81ff>0</span>          18h     172.17.89.17   k8s-node7   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-flannel-ds-nj6tj     1/1     Running   <span style=color:#ae81ff>2</span>          114m    172.17.89.7    k8s-node8   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get svc --all-namespaces 
</span></span><span style=display:flex><span>NAMESPACE     NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>                  AGE
</span></span><span style=display:flex><span>default       kubernetes   ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP                  18h
</span></span><span style=display:flex><span>kube-system   kube-dns     ClusterIP   10.0.0.2     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   10m
</span></span></code></pre></div><br><center>·End·</center></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>Hiroshi.tao</span></p><p class=copyright-item><span>Link:</span>
<a href=https://blog.saintic.com/blog/307.html>https://blog.saintic.com/blog/307.html</span></p><p class="copyright-item lincese">本文采用 <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/ target=_blank>知识共享署名-非商业性使用 4.0 国际许可协议</a> 进行许可</p></div><div class=post-tags><section><i class="saintic-icon saintic-icon-tag"></i>Tag(s):
<a href=/tags/go.html rel=tag class=post-tags-link>#go</a>
<a href=/tags/k8s.html rel=tag class=post-tags-link>#k8s</a>
<a href=/tags/docker.html rel=tag class=post-tags-link>#docker</a></section><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://blog.saintic.com>home</a></span></section></div><div class=post-nav><a href=https://blog.saintic.com/blog/308.html class=prev rel=prev title="Golang、Python（Flask）统一使用 pbkdf2 生成与验证用户密码"><i class="saintic-icon saintic-icon-angle-left"></i>&nbsp;Golang、Python（Flask）统一使用 pbkdf2 生成与验证用户密码</a>
<a href=https://blog.saintic.com/blog/309.html class=next rel=next title=应用迁移到k3s>应用迁移到k3s&nbsp;<i class="saintic-icon saintic-icon-angle-right"></i></a></div><div class=post-comment><div id=utteranc-container><script src=https://utteranc.es/client.js repo=staugur/staugur.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2017 - 2025</span>
<span class=with-love><i class="saintic-icon saintic-icon-love"></i></span>
<span class=author itemprop=copyrightHolder><a href=https://blog.saintic.com>Hiroshi.tao</a> |</span>
<a href=https://beian.miit.gov.cn/ target=_blank rel="external nofollow">京ICP备14058611号-1</a> |
<span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/SaintIC/Mogege target=_blank rel="external nofollow">Mogege</a></span>
<span>| <a href=https://www.foreverblog.cn/go.html target=_blank title=穿梭虫洞-随机访问十年之约友链博客>虫洞</span></div></footer><script defer src=/js/vendor_main.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script>
<script>pangu.spacingPage()</script><script defer src=https://blog.saintic.com/js/my.js></script></div></body></html>